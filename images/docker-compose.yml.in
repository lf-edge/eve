version: '2.3'

volumes:
    persist: {}
    config: {}
    run: {}

networks:
    eve:
        driver: bridge
        driver_opts:
            com.docker.network.bridge.enable_ip_masquerade: 'true'
            com.docker.network.bridge.default_bridge: 'true'
            com.docker.network.bridge.enable_icc: 'true'
            com.docker.network.bridge.host_binding_ipv4: '0.0.0.0'
            com.docker.network.driver.mtu: '1500'
        enable_ipv6: true
        ipam:
            config:
                - subnet: fde3:84ac:fc48::/48
                - subnet: 1.1.1.0/24

services:
    # this is the only service from the onboot: section
    storage-init:
        image: STORAGE_INIT_TAG
        volumes:
            - persist:/persist
            - config:/config
            - type: bind
              source: CURDIR/conf
              target: /conf
            - type: bind
              source: CURDIR/pkg
              target: /pkg
        networks:
            - eve

    ntpd:
        image: linuxkit/openntpd:v0.5
        privileged: true
        volumes:
            - persist:/persist
            - config:/config
            - run:/run
        networks:
            - eve

    rsyslogd:
        image: RSYSLOGD_TAG
        privileged: true
        volumes:
            - persist:/persist
            - config:/config
            - run:/run
        networks:
            - eve

    wwan:
        image: WWAN_TAG
        privileged: true
        volumes:
            - persist:/persist
            - config:/config
            - run:/run
        networks:
            - eve

    wlan:
        image: WLAN_TAG
        privileged: true
        volumes:
            - persist:/persist
            - config:/config
            - run:/run
        networks:
            - eve

    lisp:
        image: LISP_TAG
        privileged: true
        volumes:
            - persist:/persist
            - config:/config
            - run:/run
        networks:
            - eve

    guacd:
        image: GUACD_TAG
        privileged: true
        volumes:
            - persist:/persist
            - config:/config
            - run:/run
        networks:
            - eve

    vtpm:
        image: VTPM_TAG
        privileged: true
        volumes:
            - persist:/persist
            - config:/config
            - run:/run
        networks:
            - eve

    watchdog:
        image: WATCHDOG_TAG
        privileged: true
        volumes:
            - persist:/persist
            - config:/config
            - run:/run
        networks:
            - eve

    xen-tools:
        image: XENTOOLS_TAG
        privileged: true
        volumes:
            - persist:/persist
            - config:/config
            - run:/run
        networks:
            - eve

    pillar:
        image: PILLAR_TAG
        # privileged: true
        volumes:
            - persist:/persist
            - config:/config
            - run:/run
            - type: bind
              source: CURDIR/images/version.yml
              target: /opt/zededa/bin/versioninfo
            - type: bind
              source: CURDIR/images/version.yml
              target: /etc/eve-release
            - type: bind
              source: CURDIR/tools/fake-zboot.sh
              target: /usr/bin/zboot
        networks:
            - eve

    sshd:
        image: linuxkit/sshd:v0.5
        privileged: true
        volumes:
            - persist:/persist
            - config:/config
            - run:/run
        networks:
            - eve
